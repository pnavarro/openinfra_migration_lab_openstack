---
# Network Isolation role - Based on network-isolation.adoc documentation

- name: Apply NodeNetworkConfigurationPolicy for worker node 1
  kubernetes.core.k8s:
    state: present
    src: "{{ ansible_env.HOME }}/{{ files_directory }}/osp-ng-nncp-w1.yaml"

- name: Apply NodeNetworkConfigurationPolicy for worker node 2  
  kubernetes.core.k8s:
    state: present
    src: "{{ ansible_env.HOME }}/{{ files_directory }}/osp-ng-nncp-w2.yaml"

- name: Apply NodeNetworkConfigurationPolicy for worker node 3
  kubernetes.core.k8s:
    state: present
    src: "{{ ansible_env.HOME }}/{{ files_directory }}/osp-ng-nncp-w3.yaml"

- name: Wait for all NNCP to be successfully configured
  kubernetes.core.k8s_info:
    api_version: nmstate.io/v1
    kind: NodeNetworkConfigurationPolicy
  register: nncp_status
  until: >
    nncp_status.resources | length >= 3 and
    nncp_status.resources | selectattr('status.conditions', 'defined') | 
    selectattr('status.conditions', 'selectattr', 'type', 'equalto', 'Available') |
    selectattr('status.conditions', 'selectattr', 'status', 'equalto', 'True') |
    list | length >= 3
  retries: 60
  delay: 10

- name: Display NNCP status
  debug:
    msg: "NNCP {{ item.metadata.name }}: {{ item.status.conditions | selectattr('type', 'equalto', 'Available') | map(attribute='reason') | first | default('Unknown') }}"
  loop: "{{ nncp_status.resources }}"
  when: item.status.conditions is defined

- name: Apply NetworkAttachmentDefinition for isolated networks
  kubernetes.core.k8s:
    state: present
    src: "{{ ansible_env.HOME }}/{{ files_directory }}/osp-ng-netattach.yaml"

- name: Apply MetalLB IP address pools
  kubernetes.core.k8s:
    state: present
    src: "{{ ansible_env.HOME }}/{{ files_directory }}/osp-ng-metal-lb-ip-address-pools.yaml"

- name: Apply MetalLB L2 advertisements
  kubernetes.core.k8s:
    state: present
    src: "{{ ansible_env.HOME }}/{{ files_directory }}/osp-ng-metal-lb-l2-advertisements.yaml"

- name: Enable global IP forwarding for OVN
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: operator.openshift.io/v1
      kind: Network
      metadata:
        name: cluster
      spec:
        defaultNetwork:
          ovnKubernetesConfig:
            gatewayConfig:
              ipForwarding: "Global"
    merge_type: merge

- name: Verify NetworkAttachmentDefinitions are created
  kubernetes.core.k8s_info:
    api_version: k8s.cni.cncf.io/v1
    kind: NetworkAttachmentDefinition
    namespace: "{{ openstack_namespace }}"
  register: net_attach_defs

- name: Display created NetworkAttachmentDefinitions
  debug:
    msg: "Created NetworkAttachmentDefinition: {{ item.metadata.name }}"
  loop: "{{ net_attach_defs.resources }}"
